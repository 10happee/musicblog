<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blog Post with Audio Upload</title>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-analytics.js"></script>
  <style>
    /* Basic styling */
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .blog-post {
      margin: 20px 0;
      padding: 10px;
      border: 1px solid #ccc;
    }
    audio {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="username-screen">
    <label for="username">Enter Username:</label>
    <input type="text" id="username">
    <button id="continue-btn">Continue</button>
  </div>

  <div id="content-screen" style="display:none;">
    <h2>Welcome, <span id="username-display"></span>!</h2>
    
    <h3>Create a New Blog Post</h3>
    <input type="text" id="post-title" placeholder="Post Title">
    <textarea id="post-description" placeholder="Post Description"></textarea>
    <button id="add-audio-btn">Add Audio File</button>
    <input type="file" id="audio-file-input" accept="audio/*" style="display:none;">
    <button id="submit-post-btn">Submit Post</button>

    <div id="blog-posts"></div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDErOzCKFceg7Jzci80jTVJT5tVcsRKb4E",
      authDomain: "happeemusicblog.firebaseapp.com",
      databaseURL: "https://happeemusicblog-default-rtdb.firebaseio.com",
      projectId: "happeemusicblog",
      storageBucket: "happeemusicblog.firebasestorage.app",
      messagingSenderId: "452113598802",
      appId: "1:452113598802:web:334fd95fadfe4bbd16d28b",
      measurementId: "G-MRJ6M3B5FG"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Maximum file size (in bytes) to allow upload (e.g., 6MB)
    const MAX_FILE_SIZE = 6 * 1024 * 1024;

    // Handle username screen and move to content screen
    document.getElementById('continue-btn').addEventListener('click', () => {
      const username = document.getElementById('username').value;
      if (username) {
        localStorage.setItem('username', username);
        document.getElementById('username-display').innerText = username;
        document.getElementById('username-screen').style.display = 'none';
        document.getElementById('content-screen').style.display = 'block';
        loadBlogPosts();
      }
    });

    // Add Audio File
    document.getElementById('add-audio-btn').addEventListener('click', () => {
      document.getElementById('audio-file-input').click();
    });

    document.getElementById('audio-file-input').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file.size > MAX_FILE_SIZE) {
        alert("File is too large. Maximum size allowed is 6MB.");
        return;
      }

      // Convert file to base64 and save to Firebase
      convertToBase64(file).then((base64Data) => {
        document.getElementById('audio-file-input').value = ''; // Clear input
        window.audioData = base64Data; // Save audio data for later use
        alert('Audio file added successfully!');
      }).catch((error) => {
        console.error("Error encoding file:", error);
        alert("Error encoding file.");
      });
    });

    // Convert file to base64
    function convertToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Submit Post
    document.getElementById('submit-post-btn').addEventListener('click', () => {
      const title = document.getElementById('post-title').value;
      const description = document.getElementById('post-description').value;

      if (!title || !description || !window.audioData) {
        alert("Please fill in all fields, including adding an audio file.");
        return;
      }

      // Save post to Firebase
      const postRef = db.ref('blog_posts').push();
      postRef.set({
        title,
        description,
        audioData: window.audioData,
        timestamp: Date.now(),
        username: localStorage.getItem('username')
      }).then(() => {
        alert("Post submitted successfully!");
        document.getElementById('post-title').value = '';
        document.getElementById('post-description').value = '';
        window.audioData = null;
        loadBlogPosts();
      });
    });

    // Load Blog Posts
    function loadBlogPosts() {
      const postsRef = db.ref('blog_posts');
      postsRef.once('value', (snapshot) => {
        const blogPosts = snapshot.val();
        const postsContainer = document.getElementById('blog-posts');
        postsContainer.innerHTML = '';

        if (!blogPosts) {
          return;
        }

        Object.keys(blogPosts).forEach(key => {
          const post = blogPosts[key];
          const postDiv = document.createElement('div');
          postDiv.className = 'blog-post';
          postDiv.innerHTML = `
            <h3>${post.title}</h3>
            <p>${post.description}</p>
            <p>Posted by: ${post.username}</p>
            <audio controls>
              <source src="${post.audioData}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>
            <button onclick="deletePost('${key}')">Delete Post</button>
          `;
          postsContainer.appendChild(postDiv);
        });

        checkStorageSize();
      });
    }

    // Check total database size and delete old posts if necessary
    function checkStorageSize() {
      const postsRef = db.ref('blog_posts');
      postsRef.once('value', (snapshot) => {
        const posts = snapshot.val();
        let totalSize = 0;

        // Calculate total size of posts
        Object.keys(posts).forEach((key) => {
          const post = posts[key];
          totalSize += post.audioData.length;
        });

        // Check if the storage exceeds the limit (e.g., 20MB)
        const storageLimit = 20 * 1024 * 1024; // 20MB for example
        if (totalSize > storageLimit) {
          alert('Storage limit exceeded, deleting the oldest posts...');
          deleteOldestPost(posts);
        }
      });
    }

    // Delete the oldest post
    function deleteOldestPost(posts) {
      const oldestPostKey = Object.keys(posts).reduce((oldest, currentKey) => {
        return posts[oldest].timestamp < posts[currentKey].timestamp ? oldest : currentKey;
      });

      // Delete the oldest post
      db.ref('blog_posts/' + oldestPostKey).remove().then(() => {
        alert("Oldest post deleted to free up space.");
        loadBlogPosts(); // Reload posts
      });
    }

    // Delete a specific post
    function deletePost(postId) {
      db.ref('blog_posts/' + postId).remove().then(() => {
        alert("Post deleted successfully.");
        loadBlogPosts();
      });
    }
  </script>
</body>
</html>
